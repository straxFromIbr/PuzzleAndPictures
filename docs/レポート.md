
- [目的](#目的)
- [実験の概要](#実験の概要)
- [実験の実施内容](#実験の実施内容)
    - [開発したアプリケーションの概要](#開発したアプリケーションの概要)
    - [使用した技術](#使用した技術)
    - [分担](#分担)
    - [プログラムの構成](#プログラムの構成)
    - [作成したソースコード](#作成したソースコード)

# 目的
- スマートフォン用アプリケーションソフトウェアを開発するために必要な基礎知識・技術を学ぶ

# 実験の概要
- Android端末向けにアプリケーションを開発する。開発環境としてAndroid Studioを使用する。

# 実験の実施内容
## 開発したアプリケーションの概要
今回開発したアプリケーションは、ランダムに表示される画像の断片を組み合わせ、画像を完成させるパズルゲームであり、名称は "Puzzle And Pictures"である。


画面はつぎに示される画像の通りで、画面中央部の4x4のマス目が"パズルエリア"、その下の横一列にマス目が4つ並んだ部分が画像の断片が表示される"ガチャエリア"、最下部の2つのボタンはそれぞれ、"ガチャボタン"、"クリアボタン"である。

![](./images/mainview.png)

それぞれ次のような機能を持つ。
- パズルエリア
    - ガチャエリアに表示された画像を配置しパズルを完成させる部分。
- ガチャエリア
    - パズルに使用する画像の断片が4枚表示される。
- ガチャボタン
    - 押すことでガチャエリアに4枚の画像の断片を無作為に表示する。
- クリアボタン
    - パズルエリアの表示を初期化する。


ユーザは次のようにしてアプリを使用する。
1. ガチャボタンをタップする。
1. ガチャエリアに表示された画像のうち1つをタップし選択する。
1. 選択した写真を配置する場所をパズルエリアから選択する。
1. もし配置する場所を間違えた場合、クリアボタンでパズルエリアを初期化する。
1. もしガチャエリアに置きたい写真がなくなった場合、ガチャボタンをタップし2に戻る。

## 使用した技術
本アプリケーションはJetPack Composeを用い、Kotlinで記述し開発した。プログラムの構成はModel View ViewModel(MVVM)アーキテクチャに沿うようにした。
また開発環境としてAndroid Studio Arctic Foxを使用した。

## 分担
初期のアイデアは佐藤が考案し、またパズルエリアのモデルの作成をした。 伊藤と大内はデザインの定義とレイアウトの作成を担当した。 芳賀はおおまかな設計の提案と他3名が作成した部品の統合を担当した。

次に各班員が作成したファイルを示す。
- 伊藤：`view/GachaView.kt`
- 大内：`ui/theme/Color.kt`、`view/ButtonView.kt`
- 佐藤：`repository/MainPictureRepository.kt`
- 芳賀：`repository/GachaRepository.kt`, `viewmodel/MainViewModel.kt`, `view/MainView.kt`, その他データクラス、ユーティリティ関数の定義


## プログラムの構成
プロジェクトのファイル群はGitHubリポジトリ[straxFromIbr/PuzzleAndPictures](https://github.com/straxFromIbr/PuzzleAndPictures/tree/b7f41946681e5006868df870e1d6d353433cc5fa)にアップロードしてある。

以下にディレクトリの構成の概観を示す。
- `PuzzleAndPictures/app/src/main/java/com/example/puzzleandpictures/`:ソースコードのルート
    - `repository/` 
        - MVVMのModel部分に相当する、ドメインロジックへのインタフェースを提供する。
        - `GachaRepository.kt` はガチャエリアに表示される画像のIDを生成する。
        - `MainPictureRepository.kt` はパズルエリアの画像の状態の保持と更新を行う。
    - `ui/theme/`
        - 色彩などを定義している。
    - `viewmodel/`
        - MVVMのViewModel部分に相当する。
        - `repository/`への参照を持ち、ユーザのアクション時に呼び出される関数と、モデルの操作を対応づけている。
    - `view/`
        - MVVMのView部分に相当する。
        - ViewModelへの参照を持ち、画面に表示される部品や、ボタンのクリックなどのアクション時にViewModelの対応するメソッドの呼び出しを定義する。
        - `MainView.kt`で画面全体を定義している。
    - `MainActivity.kt`
        - ViewModelをインスタンス作成し、`MainView`関数に渡して呼び出している。
        
また`repository/`内で次の2つのデータクラスを実装した。
- `RowPicIDs`
    -これはガチャエリアやパズルエリアの各行の、横一列に4つ並ぶ画像のIDを保持するためのデータクラスである。
    ```kotlin
    data class RowPicIDs (
        var a: Int = -1,
        var b: Int = -1,
        var c: Int = -1,
        var d: Int = -1,
    )
    ```
- `MainPictureIDs`
    - これはパズルエリア全体の画像のIDを保持するためのデータクラスである。

    ```kotlin
    data class MainPictureIDs(
        val row1: RowPicIDs = RowPicIDs(),
        val row2: RowPicIDs = RowPicIDs(),
        val row3: RowPicIDs = RowPicIDs(),
        val row4: RowPicIDs = RowPicIDs(),
    )
    ```


また、パズルで使用した画像ファイルは`PuzzleAndPictures/app/src/main/res/drawable`にJPEGで保存している。

## 作成したソースコード
次に作成を担当したしたソースコードの抜粋を示す。
全ファイルは[straxFromIbr/PuzzleAndPictures](https://github.com/straxFromIbr/PuzzleAndPictures/tree/b7f41946681e5006868df870e1d6d353433cc5fa)で参照できる。

- `repository/GachaRepository.kt`
    - 乱数で初期化されたRowPicIDsデータクラスを返却する。

    ```kotlin
    package com.example.puzzleandpictures.repository
    class GachaRepository {
        fun doGacha(): RowPicIDs {
            val range = (0..15)
            return RowPicIDs(range.random(), range.random(), range.random(), range.random())
        }
    }
    ```

- `viewmodel/MainViewModel.kt`
    - UIへの操作に応じてモデルのメソッドを呼び出している。
    ```kotlin
    package com.example.puzzleandpictures.viewmodel

    // import文は省略した

    class MainViewModel() : ViewModel() {
        // モデルのインスタンス作成
        // 時間の都合上DIは実施していない。
        private val mainPictureRepository: MainPictureRepository = MainPictureRepository()
        private val gachaRepository: GachaRepository = GachaRepository()

        private var selectedPicID: Int = 16
        private var isPicSelected = false

        val gachaResultIDs: MutableState<RowPicIDs> = mutableStateOf(RowPicIDs())
        val mainPictureIDs: MutableState<MainPictureIDs> = mutableStateOf(MainPictureIDs())

        fun onGachaTapped() {
            // ガチャボタンがタップされた時の処理
            gachaResultIDs.value = gachaRepository.doGacha()
        }

        fun onPicSelected(imageID: Int) {
            // ガチャエリアから画像が選択された時の処理
            selectedPicID = imageID
            isPicSelected = true
        }

        fun onPlaceSelected(placeID: Int) {
            // パズルエリアに写真を配置する場所を選択した時の処理
            if (isPicSelected) {
                val resultArray = mainPictureRepository.Place_Pic(selectedPicID, placeID)
                mainPictureIDs.value = convertArrayToAllPicIDs(resultArray)
                isPicSelected = false
            }
        }

        fun onClearTapped() {
            // クリアボタンが押された時の処理
            mainPictureRepository.Clear()
            mainPictureIDs.value = convertArrayToAllPicIDs(mainPictureRepository.current_pic)
        }

        private fun convertArrayToAllPicIDs(array16: IntArray): MainPictureIDs {
            // MainPictureRepositoryの返り値をMainPictureIDs型に変換する処理
            val row0 = RowPicIDs(array16[0], array16[1], array16[2], array16[3])
            val row1 = RowPicIDs(array16[4], array16[5], array16[6], array16[7])
            val row2 = RowPicIDs(array16[8], array16[9], array16[10], array16[11])
            val row3 = RowPicIDs(array16[12], array16[13], array16[14], array16[15])
            return MainPictureIDs(row0, row1, row2, row3)
        }
    }
    ```

    - `view/MainView.ky`
        - 引数として与えられたViewModelのプロパティとメソッドを各UI部品に渡している。
            
    ```kotlin
    package com.example.puzzleandpictures.view

    @Composable
    fun MainView(mainViewModel: MainViewModel) {
        val mainPictureIDs: MainPictureIDs by mainViewModel.mainPictureIDs
        val gachaResultIDs: RowPicIDs by mainViewModel.gachaResultIDs

        val padding = 16.dp

        Column(
            Modifier.fillMaxSize(),
            verticalArrangement = Arrangement.Center,
            horizontalAlignment = Alignment.CenterHorizontally,
        ) {
            MainPictureView(
                mainPictureIDs,
                mainViewModel::onPlaceSelected
            )
            Spacer(Modifier.size(padding))
            GachaResultView(
                rowPicIDs = gachaResultIDs,
                onPicSelected = mainViewModel::onPicSelected
            )
            Spacer(Modifier.size(padding))
            ShowButtons(
                onGachaTapped = mainViewModel::onGachaTapped,
                onClearTapped = mainViewModel::onClearTapped,
            )
        }
    }
    ```
